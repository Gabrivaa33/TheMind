<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>The Mind - Muerte Instantánea</title>

  <style>
    *{box-sizing:border-box;margin:0;padding:0;font-family:'Segoe UI',Tahoma,sans-serif;}
    body{
      background:linear-gradient(135deg,#1a2a6c,#b21f1f,#fdbb2d);
      min-height:100vh;color:white;padding:20px;
    }
    .container{
      max-width:900px;margin:0 auto;
      background:rgba(0,0,0,0.7);
      padding:20px;border-radius:15px;
      box-shadow:0 10px 30px rgba(0,0,0,0.5);
    }
    h1{text-align:center;color:#fdbb2d;margin-bottom:20px;}

    /* MENÚ INICIAL ORIGINAL */
    .setup-screen{display:none;max-width:420px;margin:0 auto;padding:20px;}
    .setup-screen.active{display:block;}
    .setup-row{display:flex;flex-direction:column;margin-bottom:12px;gap:4px;}
    .setup-input{padding:8px;border-radius:6px;border:none;outline:none;}
    .setup-buttons{display:flex;justify-content:center;gap:12px;margin-top:10px;}
    button.primary{
      background:#fdbb2d;color:#1a2a6c;font-weight:bold;
      padding:10px 18px;border:none;border-radius:6px;
    }
    button.secondary{
      background:white;color:#1a2a6c;font-weight:bold;
      padding:10px 18px;border:none;border-radius:6px;
    }

    /* WAITING */
    .waiting-screen{display:none;}
    .waiting-screen.active{display:block;}
    .waiting-players{
      display:flex;flex-wrap:wrap;gap:10px;
      justify-content:center;margin:15px 0;
    }
    .waiting-player{
      padding:10px;border-radius:10px;
      min-width:140px;text-align:center;
      background:rgba(255,255,255,0.06);
      border:1px solid rgba(255,255,255,0.1);
    }

    /* GAME */
    .game-screen{display:none;}
    .game-screen.active{display:block;}
    .player-info{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:20px;}
    .player{
      background:rgba(255,255,255,0.06);
      border-radius:10px;padding:10px;
      min-width:150px;text-align:center;
    }
    .player-name{font-weight:bold;margin-bottom:6px;}

    .player-cards{
      display:flex;justify-content:center;gap:6px;flex-wrap:wrap;
    }
    .card{
      width:48px;height:68px;
      background:white;color:#333;border-radius:6px;
      display:flex;align-items:center;justify-content:center;
      font-weight:bold;cursor:pointer;
      transition:.15s;box-shadow:0 2px 6px rgba(0,0,0,0.4);
    }
    .card:hover{transform:translateY(-6px);}
    .card.selected{transform:translateY(-10px);box-shadow:0 6px 18px rgba(253,187,45,0.7);}
    .card.blocked{background:#ff4444;color:white;cursor:not-allowed;}
    .card.played{background:#4CAF50;color:white;}

    .played-cards{
      display:flex;gap:10px;flex-wrap:wrap;justify-content:center;
      background:rgba(255,255,255,0.06);
      padding:10px;border-radius:10px;margin-bottom:10px;
    }

    .controls{display:flex;gap:10px;justify-content:center;margin:12px 0;}
    button{padding:10px 18px;border-radius:6px;border:none;cursor:pointer;font-weight:bold;}
    button:hover{opacity:0.9;}
    button:disabled{background:#555;cursor:not-allowed;}

    .message{
      text-align:center;margin-top:8px;padding:10px;border-radius:6px;
    }
    .message.error{background:rgba(255,0,0,0.3);}
    .message.warning{background:rgba(255,165,0,0.25);}
    .message.success{background:rgba(0,200,0,0.25);}

    /* END */
    .end-screen{display:none;text-align:center;}
    .end-screen.active{display:block;}
  </style>
</head>

<body>
<div class="container">
  <h1>The Mind — Muerte Instantánea</h1>

  <!-- MENU INICIAL ORIGINAL -->
  <div class="setup-screen active">
    <h2 style="text-align:center;margin-bottom:15px;">Crear o unirse a una partida</h2>

    <div class="setup-row">
      <label>Tu nombre:</label>
      <input id="playerName" class="setup-input" value="Jugador">
    </div>

    <div class="setup-row">
      <label>Nº jugadores:</label>
      <select id="numPlayers" class="setup-input">
        <option>2</option><option>3</option>
        <option selected>4</option>
        <option>5</option><option>6</option>
      </select>
    </div>

    <div class="setup-row">
      <label>Cartas por jugador:</label>
      <select id="cardsPerPlayer" class="setup-input">
        <option>1</option><option>2</option>
        <option selected>3</option><option>4</option><option>5</option>
      </select>
    </div>

    <div class="setup-row">
      <label>Código (para unirse):</label>
      <input id="gameCode" class="setup-input" placeholder="ABC1">
    </div>

    <div class="setup-buttons">
      <button id="createGame" class="primary">Crear Partida</button>
      <button id="joinGame" class="secondary">Unirse</button>
    </div>
  </div>

  <!-- WAITING -->
  <div class="waiting-screen">
    <h2 style="text-align:center;margin-bottom:10px;">Esperando jugadores…</h2>
    <h3 style="text-align:center;">Código: <span id="displayGameCode">----</span></h3>
    <div id="waitingPlayers" class="waiting-players"></div>

    <div class="controls">
      <button id="startGame">Iniciar</button>
      <button id="cancelGame">Cancelar</button>
    </div>
  </div>

  <!-- GAME -->
  <div class="game-screen">
    <div style="display:flex;justify-content:space-between;margin-bottom:10px;">
      <div>Jugadores: <span id="pcount"></span></div>
      <div>Jugadas: <span id="playedCount"></span>/<span id="totalCount"></span></div>
    </div>

    <div id="playersContainer" class="player-info"></div>

    <h3 style="text-align:center;">Cartas jugadas</h3>
    <div id="playedCards" class="played-cards"></div>

    <div id="gameMessage" class="message" style="display:none;"></div>

    <div class="controls">
      <button id="playCard" disabled>Jugar</button>
      <button id="endGame">Terminar</button>
    </div>
  </div>

  <!-- END -->
  <div class="end-screen">
    <h2 id="endTitle"></h2>
    <p id="endDetails"></p>
    <button id="playAgain">Volver</button>
  </div>

</div>

<!-- ======================================================
     ===============  SCRIPT COMPLETO  =====================
     ======================================================-->
<script>
  (function(){
    let localState={
      playerId:null,players:[],playedCards:[],
      gameCode:'',cardsPerPlayer:3,totalCards:0,
      gameStarted:false,gameOver:false,selectedCard:null,isHost:false
    };

    function $(id){return document.getElementById(id);}

    const createBtn=$("createGame"),joinBtn=$("joinGame"),
      startBtn=$("startGame"),cancelBtn=$("cancelGame"),
      playBtn=$("playCard"),endBtn=$("endGame"),playAgainBtn=$("playAgain"),
      waitingPlayersEl=$("waitingPlayers"),playersContainer=$("playersContainer"),
      playedCardsEl=$("playedCards"),msgEl=$("gameMessage"),
      pcountEl=$("pcount"),playedCountEl=$("playedCount"),
      totalCountEl=$("totalCount"),displayGameCodeEl=$("displayGameCode");

    const setupScreen=document.querySelector(".setup-screen"),
      waitingScreen=document.querySelector(".waiting-screen"),
      gameScreen=document.querySelector(".game-screen"),
      endScreen=document.querySelector(".end-screen"),
      endTitle=$("endTitle"),endDetails=$("endDetails");

    /* INITIALIZE */
    (function init(){
      let pid=sessionStorage.getItem("tm_player_id");
      if(!pid){pid="p_"+Math.random().toString(36).substr(2,9);sessionStorage.setItem("tm_player_id",pid);}
      localState.playerId=pid;

      createBtn.onclick=createGame;
      joinBtn.onclick=joinGame;
      startBtn.onclick=startGameFromWaiting;
      cancelBtn.onclick=cancelGame;
      playBtn.onclick=playCard;
      endBtn.onclick=()=>endGameImmediate(false,"manual");
      playAgainBtn.onclick=resetToSetup;

      window.addEventListener("storage",storageSync);
      setInterval(pollSync,1000);
    })();

    /* --------- CREATE / JOIN --------- */
    function createGame(){
      const name=$("playerName").value||"Jugador";
      const maxPlayers=parseInt($("numPlayers").value);
      const cards=parseInt($("cardsPerPlayer").value);
      const codeInput=$("gameCode").value;
      const code=(codeInput?codeInput.toUpperCase():genCode());

      localState.isHost=true;
      localState.gameCode=code;
      localState.cardsPerPlayer=cards;

      const gd={
        code,host:localState.playerId,maxPlayers,cardsPerPlayer:cards,
        players:[{id:localState.playerId,name,joined:true}],
        gameStarted:false,playedCards:[],deck:[],gameOver:false
      };
      localStorage.setItem("mind_game_"+code,JSON.stringify(gd));
      showWaiting();
    }

    function joinGame(){
      const name=$("playerName").value||"Jugador";
      const code=($("gameCode").value||"").toUpperCase();
      if(!code)return m("Introduce un código","error");

      let raw=localStorage.getItem("mind_game_"+code);
      if(!raw)return m("Juego no encontrado","error");

      let gd=JSON.parse(raw);
      if(gd.gameStarted)return m("El juego ya comenzó","error");
      if(gd.players.length>=gd.maxPlayers)return m("Partida llena","error");

      gd.players.push({id:localState.playerId,name,joined:true});
      localStorage.setItem("mind_game_"+code,JSON.stringify(gd));

      localState.isHost=false;
      localState.gameCode=code;
      localState.cardsPerPlayer=gd.cardsPerPlayer;
      showWaiting();
    }

    function showWaiting(){
      setupScreen.classList.remove("active");
      waitingScreen.classList.add("active");
      updateWaiting();
    }

    function updateWaiting(){
      const raw=localStorage.getItem("mind_game_"+localState.gameCode);
      if(!raw)return;
      const gd=JSON.parse(raw);

      waitingPlayersEl.innerHTML="";
      for(let i=0;i<gd.maxPlayers;i++){
        const el=document.createElement("div");
        el.className="waiting-player";
        if(i<gd.players.length){
          el.textContent=gd.players[i].name;
          el.style.background="rgba(253,187,45,0.12)";
          el.style.border="1px solid rgba(253,187,45,0.25)";
        }else{
          el.textContent="Esperando…";
        }
        waitingPlayersEl.appendChild(el);
      }
      displayGameCodeEl.textContent=gd.code;
    }

    /* --------- START GAME --------- */
    function startGameFromWaiting(){
      const raw=localStorage.getItem("mind_game_"+localState.gameCode);
      if(!raw)return;
      const gd=JSON.parse(raw);

      if(gd.players.length<2)return m("Mínimo 2 jugadores","error");

      const deck=[...Array(100).keys()].map(n=>n+1);
      shuffle(deck);
      gd.gameStarted=true;
      gd.playedCards=[];
      gd.players.forEach(p=>{
        p.cards=deck.splice(0,gd.cardsPerPlayer).sort((a,b)=>a-b);
      });
      gd.deck=deck;

      localStorage.setItem("mind_game_"+localState.gameCode,JSON.stringify(gd));
      startGame();
    }

    function startGame(){
      const raw=localStorage.getItem("mind_game_"+localState.gameCode);
      if(!raw)return;
      const gd=JSON.parse(raw);

      localState.players=gd.players;
      localState.playedCards=gd.playedCards;
      localState.totalCards=gd.players.length*gd.cardsPerPlayer;
      localState.gameStarted=true;
      localState.gameOver=false;

      waitingScreen.classList.remove("active");
      gameScreen.classList.add("active");
      updateGameUI();
    }

    /* --------- SYNC --------- */
    function storageSync(e){
      if(!e.key)return;
      if(!localState.gameCode)return;
      const key="mind_game_"+localState.gameCode;
      if(e.key===key){
        const raw=localStorage.getItem(key);
        if(!raw){ m("Juego cancelado","error"); resetToSetup(); return; }
        const gd=JSON.parse(raw);

        if(gd.gameStarted && !localState.gameStarted){ startGame(); return; }
        if(localState.gameStarted){ syncFromStore(); }
        else updateWaiting();
      }
    }
    function pollSync(){
      if(!localState.gameCode)return;
      const raw=localStorage.getItem("mind_game_"+localState.gameCode);
      if(!raw)return;
      if(localState.gameStarted)syncFromStore();
    }
    function syncFromStore(){
      const raw=localStorage.getItem("mind_game_"+localState.gameCode);
      if(!raw)return;
      const gd=JSON.parse(raw);
      if(gd.gameOver){ handleGameOver(gd); return; }
      localState.players=gd.players;
      localState.playedCards=gd.playedCards;
      updateGameUI();
    }

    /* --------- GAME UI --------- */
    function updateGameUI(){
      pcountEl.textContent=localState.players.length;
      playedCountEl.textContent=localState.playedCards.length;
      totalCountEl.textContent=localState.totalCards;

      playersContainer.innerHTML="";
      localState.players.forEach(p=>{
        const wrap=document.createElement("div");
        wrap.className="player";

        const nm=document.createElement("div");
        nm.className="player-name";
        nm.textContent=(p.id===localState.playerId ? p.name+" (Tú)" : p.name);
        wrap.appendChild(nm);

        const cards=document.createElement("div");
        cards.className="player-cards";

        if(p.cards){
          if(p.id===localState.playerId){
            p.cards.forEach(c=>{
              const el=document.createElement("div");
              el.className="card"; el.textContent=c; el.dataset.c=c;

              const last=localState.playedCards.slice(-1)[0]||0;
              if(c<last){ el.classList.add("blocked"); }
              else el.onclick=()=>selectCard(c);

              if(localState.selectedCard===c)el.classList.add("selected");
              cards.appendChild(el);
            });
          }else{
            p.cards.forEach(()=> {
              const h=document.createElement("div");
              h.className="card";
              h.textContent="?";
              h.style.background="#333";
              h.style.color="white";
              cards.appendChild(h);
            });
          }
        }
        wrap.appendChild(cards);
        playersContainer.appendChild(wrap);
      });

      playedCardsEl.innerHTML="";
      localState.playedCards.forEach(c=>{
        const el=document.createElement("div");
        el.className="card played";
        el.textContent=c;
        playedCardsEl.appendChild(el);
      });

      playBtn.disabled=!localState.selectedCard;
    }

    /* --------- PLAY CARD --------- */
    function selectCard(c){
      const me=localState.players.find(p=>p.id===localState.playerId);
      if(!me || !me.cards.includes(c))return;
      const last=localState.playedCards.slice(-1)[0]||0;
      if(c<last)return m("No puedes jugar una menor","warning");

      localState.selectedCard=c;
      updateGameUI();
    }

    function playCard(){
      if(!localState.selectedCard)return;

      const raw=localStorage.getItem("mind_game_"+localState.gameCode);
      if(!raw)return;
      const gd=JSON.parse(raw);

      const played=localState.selectedCard;
      const last=gd.playedCards.slice(-1)[0]||0;
      if(played<last){ m("No puedes jugar una menor","error"); return; }

      const me=gd.players.find(p=>p.id===localState.playerId);
      me.cards=me.cards.filter(x=>x!==played);

      gd.playedCards.push(played);

      const lower=[];
      gd.players.forEach(p=>{
        if(p.id===localState.playerId)return;
        const L=(p.cards||[]).filter(x=>x<played);
        if(L.length){ lower.push(...L); p.cards=p.cards.filter(x=>x>=played); }
      });

      if(lower.length){
        gd.playedCards.push(...lower.sort((a,b)=>a-b));
        gd.gameOver=true;
        gd.gameResult={success:false,reason:"blocked",revealed:lower,by:localState.playerId};
        localStorage.setItem("mind_game_"+localState.gameCode,JSON.stringify(gd));
        handleGameOver(gd);
        return;
      }

      localStorage.setItem("mind_game_"+localState.gameCode,JSON.stringify(gd));
      localState.selectedCard=null;
      syncFromStore();
      checkVictory();
    }

    function checkVictory(){
      const raw=localStorage.getItem("mind_game_"+localState.gameCode);
      if(!raw)return;
      const gd=JSON.parse(raw);
      const done=gd.players.every(p=>!p.cards.length);

      if(done){
        gd.gameOver=true;
        gd.gameResult={success:true,reason:"victory"};
        localStorage.setItem("mind_game_"+localState.gameCode,JSON.stringify(gd));
        handleGameOver(gd);
      }
    }

    /* --------- END --------- */
    function endGameImmediate(succ,reason){
      const raw=localStorage.getItem("mind_game_"+localState.gameCode); if(!raw)return;
      const gd=JSON.parse(raw);
      gd.gameOver=true;
      gd.gameResult={success:!!succ,reason};
      localStorage.setItem("mind_game_"+localState.gameCode,JSON.stringify(gd));
      handleGameOver(gd);
    }

    function handleGameOver(gd){
      localState.gameOver=true;
      gameScreen.classList.remove("active");
      endScreen.classList.add("active");

      if(gd.gameResult.success){
        endTitle.textContent="¡VICTORIA!";
        endDetails.innerHTML="Se han jugado todas las cartas.";
      }else{
        endTitle.textContent="¡DERROTA!";
        if(gd.gameResult.revealed)
          endDetails.innerHTML="Cartas menores reveladas: <b>"+gd.gameResult.revealed.join(", ")+"</b>";
        else endDetails.textContent="Error en la partida.";
      }
    }

    /* --------- HELPERS --------- */
    function cancelGame(){
      if(localState.isHost)
        localStorage.removeItem("mind_game_"+localState.gameCode);
      resetToSetup();
    }
    function resetToSetup(){
      localState={playerId:localState.playerId,players:[],playedCards:[],
        gameCode:'',cardsPerPlayer:3,totalCards:0,
        gameStarted:false,gameOver:false,selectedCard:null,isHost:false};

      setupScreen.classList.add("active");
      waitingScreen.classList.remove("active");
      gameScreen.classList.remove("active");
      endScreen.classList.remove("active");
    }
    function m(text,type){
      msgEl.textContent=text;
      msgEl.className="message "+type;
      msgEl.style.display="block";
      setTimeout(()=>msgEl.style.display="none",2500);
    }
    const genCode=()=>Math.random().toString(36).substr(2,4).toUpperCase();
    function shuffle(a){
      for(let i=a.length-1;i>0;i--){
        const j=Math.floor(Math.random()*(i+1));
        [a[i],a[j]]=[a[j],a[i]];
      }
    }
  })();
</script>

</body>
</html>
